(function(e){"use strict";function t(e){e&&e.length>2&&"."===e[0]&&"/"===e[1]&&(e=e.slice(2));var t=n[e],r=null;if("function"==typeof t){var o={};n[e]=o,t(o),r=o}else{if("object"!=typeof t)throw"Unknown module "+e;r=t}return r}var n={};n.SimsawBaas=function(n){function r(e){var t=0;for(t;e.length>t;t++)if(e[t].supportsCurrentRuntime())return e[t];throw Error("Unsupported browser - no suitable providers are available.")}var o=t("Extensions"),i=t("Validate"),s=t("Promises"),a={},l=null,u=/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})(?:\.(\d*))?Z$/,c=!JSON.stringify(new Date(100)).match(/\.100Z"$/);n.async=function(e){return function(){var t=this,n=arguments;return new s.Promise(function(r){var i=function(e){e?alert("Error: "+e.message):r.apply(null,Array.prototype.slice.call(arguments,1))};Array.prototype.push.call(n,i);try{e.apply(t,n)}catch(s){i(o.createError(s))}})}},n.addToClientNamespace=function(t){var n=e.SimsawBaas=e.SimsawBaas||{},r=null;for(r in t)t.hasOwnProperty(r)&&(n[r]=t[r])},n.getSetting=function(e){return a[e]},n.setSetting=function(e,t){a[e]=t},n.webRequest=function(e,n){return l||(l=r([t("AjaxTransport"),t("IframeTransport")])),l.performRequest(e,n)},n.login=function(e,n,o){var i=/^[a-z]+:/,s="https:";return e=e.replace(i,s),n=n.replace(i,s),r([t("BrowserPopup")]).login(e,n,o)},n.toJson=function(e){return JSON.stringify(e,function(e,t){if(c&&this&&o.isDate(this[e])){var n=this[e].getMilliseconds(),r=(n+1e3+"").substring(1);t=t.replace(u,function(e,t){return t+"."+r+"Z"})}return t})},n.tryParseIsoDateString=function(e){i.isString(e);var t=u.exec(e);if(t){var n=t[1],r=t[2]||"0",o=Math.round(1e3*Number("0."+r));n=n.replace(/\-/g,"/").replace("T"," ");var s=Date.parse(n+" UTC");if(!isNaN(s))return new Date(s+o)}return null},n.mutateOnSave=!1},n.BaasClient=function(e){function n(e,t){i.isString(t,"applicationKey"),this.baasUrl=e,this.accessToken=t||null,this.currentUser=null,this.baasLogin=new u(this),this.getCollection=function(e){return i.isString(e,"collectionName"),i.notNullOrEmpty(e,"collectionName"),new l(e,this)}}function r(){var e=null,t=s.Config_AppIdKey,n=a.getSetting(t);return o.isNull(n)?(e=o.createUniqueInstallationId(),a.setSetting(t,e)):e=n,e}var o=t("Extensions"),i=t("Validate"),s=t("Resource").Resource,a=t("SimsawBaas"),l=t("BaasData").BaasData,u=t("BaasLogin").BaasLogin;e.BaasClient=n,a.addToClientNamespace({BaasClient:n}),n.appInstallId=r(),n.userAgent=null,n.prototype.request=function(e,t,r,l,u){o.isNull(u)&&"function"==typeof l&&(u=l,l=!1),i.isString(e,"method"),i.notNullOrEmpty(e,"method"),i.isString(t,"relativePath"),i.notNull(t,"relativePath"),i.notNull(u,"callback");var c={type:e.toUpperCase()};c.url=o.url.combinePathSegments(this.baasUrl,t),c.headers={},c.headers[s.Request_Header_AppInstallId]=n.appInstallId,o.isNullOrEmpty(this.accessToken)||(c.headers[s.Request_Header_AppToken]=this.accessToken),this.currentUser&&!o.isNullOrEmpty(this.currentUser.mobileServiceAuthenticationToken)&&(c.headers[s.Request_Header_Auth]=this.currentUser.mobileServiceAuthenticationToken),o.isNull(n.userAgent)||(c.headers[s.Request_Header_UserAgent]=n.userAgent),o.isNull(r)?c.data=null:(c.headers["Content-Type"]="application/json",c.data=o.toJson(r));var f=function(e,t){o.isNull(e)?!o.isNull(t)&&(t.status>=400||0===t.status)&&(e=o.createError(null,t),t=null):e=o.createError(e),u(e,t)};a.webRequest(c,f)},n.prototype.login=a.async(function(e,t,n){this.baasLogin.login(e,t,null,n)}),n.prototype.logout=function(){this.currentUser=null}},n.BaasData=function(e){function n(e,t){this.getCollectionName=function(){return e},this.getBaasClient=function(){return t},u+="/"+t.accessToken}function r(e,t){if(!o.isNull(e)&&!o.isNull(t)){var n=null;for(n in t)e[n]=t[n]}return e}var o=t("Extensions"),i=t("Validate"),s=t("Resource").Resource,a=t("SimsawBaas"),l="_id",u="data";e.BaasData=n,n.prototype.find=a.async(function(e,t,n){e&&"function"==typeof e?(n=e,e=null,t=null):t&&"function"==typeof t&&(n=t,t=null),e=e||{},t=t||{},i.notNull(n,"callback");var r=this.getCollectionName(),s=o.url.combinePathSegments(u,r,"find");this.getBaasClient().request("POST",s,{query:e,projection:t},function(e,t){var r=null;e?n(e,r):n(null,o.fromJson(t.responseText).d)})}),n.prototype.findById=a.async(function(e,t,n){t&&"function"==typeof t&&(n=t,t={}),i.notNull(e,l),i.notNull(n,"callback"),this.find({_id:""+e},t,function(e,t){n(e,t[0])})}),n.prototype.insert=a.async(function(e,t){if(i.notNull(e,"model"),i.notNull(t,"callback"),e[l])throw o.format(s.Error_Data_Insert_IdAlreadySet,l);var n=o.url.combinePathSegments(u,this.getCollectionName());this.getBaasClient().request("POST",n,e,function(n,i){if(n)t(n,null);else{var s=o.fromJson(i.responseText);a.mutateOnSave&&(s=r(e,s)),t(null,s)}})}),n.prototype.update=a.async(function(e,t){i.notNull(e,"model"),i.notNull(e[l],"model."+l),i.notNull(t,"callback");var n=o.url.combinePathSegments(u,this.getCollectionName(),""+e[l]);this.getBaasClient().request("PUT",n,e,function(n,i){if(n)t(n,null);else{var s=o.fromJson(i.responseText);a.mutateOnSave&&(s=r(e,s)),t(null,s)}})}),n.prototype.remove=a.async(function(e,t){i.notNull(e,"item id"),i.isString(e,"item id"),i.notNull(t,"callback");var n=o.url.combinePathSegments(u,this.getCollectionName(),e);this.getBaasClient().request("DELETE",n,null,function(e){t(e)})})},n.BaasLogin=function(e){function n(e,t){l.isNull(t)&&(t=!0),u.notNull(e),u.isObject(e,"client"),this.loginState={inProcess:!1,cancelCallback:null},this.ignoreFilters=t,this.getBaasClient=function(){return e},this.getLoginInProcess=function(){return this.loginState.inProcess}}function r(e){var t=0,n=p.length;for(t;n>t;t++)if(p[t]===e)return!0;return!1}function o(e,t,n,r){var o=null;l.isNull(e)&&(!l.isNull(t)&&l.isObject(t)&&l.isObject(t.user)&&l.isString(t.authenticationToken)?(n.currentUser=t.user,n.currentUser.mobileServiceAuthenticationToken=t.authenticationToken,o=n.currentUser):e=c.Error_LoginFormatInvalid),l.isNull(r)||r(e,o)}function i(e,t,n,r){var i=null;if(l.isNull(e))try{i=l.fromJson(t.responseText)}catch(s){e=s}o(e,i,n,r)}function s(e,t,n,r){var o=e.getBaasClient();e.loginState={inProcess:!0,cancelCallback:null},o.request("POST",c.Url_Login+"/"+t,n,e.ignoreFilters,function(t,n){e.loginState={inProcess:!1,cancelCallback:null},i(t,n,o,r)})}function a(e,t,n,r){var i=e.getBaasClient(),s=l.url.combinePathSegments(i.baasUrl,c.Url_Login,t),a=null;n||(a=l.url.combinePathSegments(i.baasUrl,c.Url_Login,c.Url_LoginDone)),e.loginState={inProcess:!0,cancelCallback:null};var u=f.login(s,a,function(t,n){e.loginState={inProcess:!1,cancelCallback:null},o(t,n,i,r)});e.loginState.inProcess&&u&&u.cancelCallback&&(e.loginState.cancelCallback=u.cancelCallback)}var l=t("Extensions"),u=t("Validate"),c=t("Resource").Resource,f=t("SimsawBaas"),p=["facebook","google","twitter","simsaw"];e.BaasLogin=n,f.addToClientNamespace({BaasLogin:n}),n.prototype.login=function(e,t,n,o){if(l.isNull(o)&&(l.isNull(n)||"function"!=typeof n?l.isNull(t)||"function"!=typeof t||(o=t,n=null,t=null):(o=n,n=null)),l.isNull(n)&&(l.isBool(t)?(n=t,t=null):n=!1),l.isNull(t)&&l.isString(e)&&3===e.split(".").length&&(t=e,e=null),l.isNull(e)&&(u.notNull(t),u.isString(t)),l.isNull(t)&&(u.notNull(e),u.isString(e),e=e.toLowerCase(),!r(e)))throw c.Error_LoginProviderInvalid;l.isNull(e)?this.loginWithSimsawBaasToken(t,o):this.loginWithProvider(e,t,n,o)},n.prototype.loginWithSimsawBaasToken=function(e,t){var n=this,r=n.getBaasClient();u.isString(e,"authenticationToken"),u.notNullOrEmpty(e,"authenticationToken"),r.request("POST",c.Url_Login,{authenticationToken:e},n.ignoreFilters,function(e,n){i(e,n,r,t)})},n.prototype.loginWithProvider=function(e,t,n,o){if(l.isNull(o)&&(l.isNull(n)&&"function"==typeof t?(o=t,t=null,n=!1):"function"==typeof n&&(o=n,n=!1,!l.isNull(t)&&l.isBool(t)&&(n=t,t=null))),u.isString(e,"provider"),l.isNull(t)||u.isObject(t,"token"),this.loginState.inProcess){var i=this.loginState.cancelCallback&&this.loginState.cancelCallback();if(!i)throw c.Error_LoginInProgress}if(e=e.toLowerCase(),!r(e))throw l.format(c.Error_Val_Auth_Provide_Not_Supported,p.join(", "));l.isNull(t)?a(this,e,n,o):s(this,e,t,o)}},n.Resource=function(e){e.Resource={Config_AppIdKey:"SimsawBaass.Installation.config",Url_Login:"login",Url_LoginDone:"done",Request_Header_Auth:"X-SS-BAAS-AUTH",Request_Header_AppToken:"X-SS-BAAS-TOKEN",Request_Header_AppInstallId:"X-SS-BAAS-INSTALL-ID",Request_Header_UserAgent:"User-Agent",Error_Val_Not_Null:"{0} cannot be null.",Error_Val_Not_Null_Or_Empty:"{0} cannot be null or empty.",Error_Val_Type_Check:"{0} is expected to be a value of type {1}, not {2}.",Error_Val_Length_Unexpected:"{0} is expected to have length {1}, not {2}.",Error_Val_Argument_Indexed:"argument[{0}]",Error_Val_Auth_Provide_Not_Supported:"Authentication provider not supported. Please specify one of {0}.",Error_Val_Inv_Param_Begins_With_Dollar:"{0} contains an invalid user-defined query string parameter: {1}. User-defined query string parameters must not begin with a '$'.",Error_Default:"Unexpected failure.",Error_Conn_Failure:"Unexpected connection failure.",Error_Data_Read_MismatchedTable:"Cannot get the results of a query for table '{1}' via table '{0}'.",Error_Data_Insert_IdAlreadySet:"Cannot insert if the {0} member is already set.",Error_LoginInProgress:"Cannot start a login operation because login is already in progress.",Error_LoginFormatInvalid:"Invalid format of the authentication response.",Error_LoginProviderInvalid:"The first parameter must be the name of the authentication provider or a SimsawBaas Account authentication token."}},n.AjaxTransport=function(t){t.name="AjaxTransport",t.supportsCurrentRuntime=function(){var t=typeof e.XMLHttpRequest,n="undefined"!==(new e.XMLHttpRequest).withCredentials;return"undefined"!==t&&n},t.performRequest=function(t,n){var r=t.headers||{},o=t.url.replace(/#.*$/,""),i=t.type?t.type.toUpperCase():"GET",s=new e.XMLHttpRequest;s.onreadystatechange=function(){4===s.readyState&&n(null,s)},s.open(i,o);var a=null;for(a in r)t.headers.hasOwnProperty(a)&&s.setRequestHeader(a,t.headers[a]);s.send(t.data)}},n.IframeTransport=function(n){function r(e){e&&1223===e.status&&(e.status=204)}function o(t,n){var r=a[t];r||(r=a[t]=new i.Promise(function(n){var r=document.createElement("iframe"),o=s.getOriginRoot(window.location.href),i=function(){n(r)};r.addEventListener?r.addEventListener("load",i,!1):r.attachEvent("onload",i),r.src=t+"/crossdomain/bridge?origin="+encodeURIComponent(o),r.setAttribute("width",0),r.setAttribute("height",0),r.style.display="none",e.document.body.appendChild(r)})),r.then(n)}var i=t("Promises"),s=t("PostMessageExchange"),a=[],l=s.instance;n.name="IframeTransport",n.supportsCurrentRuntime=function(){var t=typeof e.postMessage;return"undefined"!==t},n.performRequest=function(e,t){var n=s.getOriginRoot(e.url);o(n,function(o){var i={type:e.type,url:e.url,headers:e.headers,data:e.data};l.request(o.contentWindow,i,n).then(function(e){r(e),t(null,e)},function(e){t(e,null)})})}},n.PostMessageExchange=function(n){function r(){var e=this;e.lastMessageId=0,e.hasListener=!1,e.pendingMessages={}}function o(e){var t=i(e),n=t.port?""+t.port:null,r="http:"===t.protocol&&"80"===n||"https:"===t.protocol&&"443"===n,o=n&&!r?":"+n:"";return t.protocol+"//"+t.hostname+o}function i(t){var n=e.document.createElement("a");return n.href=t,n}var s=t("Promises"),a=3e5;r.prototype.request=function(t,n,r){var o=this,i=++o.lastMessageId,l={messageId:i,contents:n};return o.ensureHasListener(),new s.Promise(function(n,s){o.pendingMessages[i]={messageId:i,complete:n,error:s,targetWindow:t,origin:r},o.pendingMessages[i].timeoutId=e.setTimeout(function(){var e=o.pendingMessages[i];e&&(delete o.pendingMessages[i],e.error({status:0,statusText:"Timeout",responseText:null}))},a),t.postMessage(JSON.stringify(l),r)})},r.prototype.ensureHasListener=function(){if(!this.hasListener){this.hasListener=!0;var e=this,t=function(){e.handleMessage.apply(e,arguments)};window.addEventListener?window.addEventListener("message",t,!1):window.attachEvent("onmessage",t)}},r.prototype.handleMessage=function(t){var n=this.tryDeserializeMessage(t.data),r=n&&n.messageId,i=r&&this.pendingMessages[r],s=i&&i.targetWindow===t.source&&i.origin===o(t.origin);s&&(e.clearTimeout(i.timeoutId),delete this.pendingMessages[r],i.complete(n.contents))},r.prototype.tryDeserializeMessage=function(e){if(!e||"string"!=typeof e)return null;try{return JSON.parse(e)}catch(t){return null}},n.instance=new r,n.getOriginRoot=o},n.BrowserPopup=function(e){function n(e,t){var n=document.createElement("iframe");return n.name="zumo-login-receiver",n.src=e+"/crossdomain/loginreceiver?completion_origin="+encodeURIComponent(t),n.setAttribute("width","0"),n.setAttribute("height","0"),n.style.display="none",document.body.appendChild(n),n}var r=t("PostMessageExchange");e.supportsCurrentRuntime=function(){return!0},e.login=function(e,t,o){var i=r.getOriginRoot(window.location.href),s=r.getOriginRoot(e),a=window.navigator.userAgent.indexOf("MSIE")>=0,l=a&&n(s,i),u=a?"iframe":"postMessage";if(e+="?completion_type="+u+"&completion_origin="+encodeURIComponent(i),!i||0!==i.indexOf("http:")&&0!==i.indexOf("https:")){var c="Login is only supported from http:// or https:// URLs. Please host your page in a web server.";return o(c,null),void 0}var f=window.open(e,"_blank","location=no"),p=function(e,t){window.clearInterval(h),f.close(),window.removeEventListener?window.removeEventListener("message",g):window.detachEvent("onmessage",g),l&&l.parentNode.removeChild(l),o(e,t)},g=function(e){var t=a?l.contentWindow:f;if(e.source===t){var n;try{n=JSON.parse(e.data)}catch(r){return}n&&"LoginCompleted"===n.type&&(n.oauth||n.error)&&p(n.error,n.oauth)}},h=window.setInterval(function(){f&&f.closed===!0&&p("canceled",null)},250);return window.addEventListener?window.addEventListener("message",g,!1):window.attachEvent("onmessage",g),{cancelCallback:function(){return p("canceled",null),!0}}}},n.Extensions=function(e){var n=t("Validate"),r=t("Resource").Resource,o=t("SimsawBaas"),i=e;e.isNull=function(e){return null===e||void 0===e},e.isNullOrEmpty=function(e){return i.isNull(e)||0===e.length},e.format=function(e){var t=e;if(n.isString(t,"message"),!i.isNullOrEmpty(t)&&arguments.length>1){var r=1;for(r;arguments.length>r;r++)for(var o="{"+(r-1)+"}";-1!==t.indexOf(o);)t=t.replace(o,arguments[r])}return t},e.isObject=function(e){return i.isNull(e)||"object"==typeof e&&!i.isDate(e)},e.isString=function(e){return i.isNull(e)||"string"==typeof e},e.isBool=function(e){return!i.isNull(e)&&"boolean"==typeof e},e.isDate=function(e){return!i.isNull(e)&&e.constructor===Date},e.isNumber=function(e){return!i.isNull(e)&&"number"==typeof e},e.toJson=function(e){return o.toJson(e)},e.fromJson=function(t){return n.isString(t,"value"),JSON.parse(t,function(t,n){if(i.isString(n)&&!i.isNullOrEmpty(n)){var r=e.tryParseIsoDateString(n);if(!i.isNull(r))return r}return n})},e.createUniqueInstallationId=function(){var e=function(e){return"0000".substring(e.length)+e},t=function(){return e(Math.floor(65536*Math.random()).toString(16))};return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},e.trimEnd=function(e,t){n.isString(e,"text"),n.notNull(e,"text"),n.isString(t,"ch"),n.notNullOrEmpty("ch","ch"),n.length(t,1,"ch");for(var r=e.length-1;r>=0&&e[r]===t;)r--;return r>=0?e.substr(0,r+1):""},e.trimStart=function(e,t){n.isString(e,"text"),n.notNull(e,"text"),n.isString(t,"ch"),n.notNullOrEmpty(t,"ch"),n.length(t,1,"ch");for(var r=0;e.length>r&&e[r]===t;)r++;return e.length>r?e.substr(r,e.length-r):""},e.url={separator:"/",combinePathSegments:function(){var e=[],t=0;for(n.notNullOrEmpty(arguments,"arguments"),t=0;arguments.length>t;t++){var o=arguments[t];n.isString(o,i.format(r.Error_Val_Argument_Indexed,t)),0!==t&&(o=i.trimStart(o||"",i.url.separator)),arguments.length-1>t&&(o=i.trimEnd(o||"",i.url.separator)),e.push(o)}return e.reduce(function(e,t){return e+i.url.separator+t})},getQueryString:function(t){n.notNull(t,"parameters"),n.isObject(t,"parameters");var r=[],o=null;for(o in t){var i=t[o];e.isObject(i)&&(i=e.toJson(i)),r.push(encodeURIComponent(o)+"="+encodeURIComponent(i))}return r.join("&")},combinePathAndQuery:function(t,r){return n.notNullOrEmpty(t,"path"),n.isString(t,"path"),n.notNullOrEmpty(r,"queryString"),n.isString(r,"queryString"),t+"?"+e.trimStart(r,"?")}},e.tryParseIsoDateString=function(e){return o.tryParseIsoDateString(e)},e.createError=function(e,t){var n={message:r.Error_Default};if(n.toString=function(){return n.message},t)if(n.request=t,0===t.status)n.message=r.Error_Conn_Failure;else try{var o=JSON.parse(t.responseText);n.message=o.err||o.error||o.description||t.statusText||r.Error_Default}catch(s){n.message=t.statusText||r.Error_Default}else i.isString(e)&&!i.isNullOrEmpty(e)?n.message=e:i.isNull(e)||(n.exception=e);return n}},n.Validate=function(e){var n=t("Extensions"),r=t("Resource").Resource;e.notNull=function(e,t){if(n.isNull(e))throw n.format(r.Error_Val_Not_Null,t||"Value")},e.notNullOrEmpty=function(e,t){if(n.isNullOrEmpty(e))throw n.format(r.Error_Val_Not_Null_Or_Empty,t||"Value")},e.isDate=function(t,o){if(e.notNull(t,o),!n.isDate(t))throw n.format(r.Error_Val_Type_Check,o||"Value","Date",typeof t)},e.isString=function(e,t){if(!n.isString(e))throw n.format(r.Error_Val_Type_Check,t||"Value","string",typeof e)},e.isObject=function(e,t){if(!n.isObject(e))throw n.format(r.Error_Val_Type_Check,t||"Value","object",typeof e)},e.length=function(t,o,i){if(e.notNull(t,i),e.isInteger(o,"length"),t.length!==o)throw n.format(r.Error_Val_Length_Unexpected,i||"Value",o,t.length)},e.isInteger=function(t,o){if(e.notNull(t,o),e.isNumber(t,o),parseInt(t,10)!==parseFloat(t))throw n.format(r.Validate_TypeCheck_Error,o||"Value","number",typeof t)},e.isNumber=function(t,o){if(e.notNull(t,o),!n.isNumber(t))throw n.format(r.Validate_TypeCheck_Error,o||"Value","Number",typeof t)}},n.Promises=function(e){(function(e){function t(e){this.callbackFrames=[],this.resolutionState=null,this.resolutionValueOrError=null,this.resolveSuccess=r(this.resolveSuccess,this),this.resolveError=r(this.resolveError,this),e&&e(this.resolveSuccess,this.resolveError)}var n={success:{},error:{}},r=function(e,t){return function(){e.apply(t,arguments)}},o=function(e){return e&&"function"==typeof e.then};t.prototype.then=function(e,n){var r={success:e,error:n,chainedPromise:new t};return this.resolutionState?this.invokeCallback(r):this.callbackFrames.push(r),r.chainedPromise},t.prototype.resolveSuccess=function(e){this.resolve(n.success,e)},t.prototype.resolveError=function(e){this.resolve(n.error,e)},t.prototype.resolve=function(e,t){if(!this.resolutionState){this.resolutionState=e,this.resolutionValueOrError=t;var n=0,r=this.callbackFrames.length;for(n;r>n;n++)this.invokeCallback(this.callbackFrames[n])}},t.prototype.invokeCallback=function(e){var t=this.resolutionState===n.success?e.success:e.error;"function"==typeof t?setTimeout(r(function(){var r,i,s=!0;try{r=t(this.resolutionValueOrError),i=n.success}catch(a){s=!1,r=a,i=n.error}s&&o(r)?r.then(e.chainedPromise.resolveSuccess,e.chainedPromise.resolveError):e.chainedPromise.resolve(i,r)},this),1):e.chainedPromise.resolve(this.resolutionState,this.resolutionValueOrError)},t.prototype.done=function(e,t){return this.then(e,t).then(null,function(e){setTimeout(function(){throw Error(e)},1)}),void 0},e.Promise=t})(e)},t("BaasClient")})(this);